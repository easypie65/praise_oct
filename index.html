
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3í•™ë…„ ì¹­ì°¬ìŠ¤í‹°ì»¤íŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* ê°„ë‹¨í•œ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .text-shadow {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        /* ìŠ¤í¬ë¡¤ë°” ë””ìì¸ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-300 to-purple-400 min-h-screen p-2 sm:p-5">
    <div id="app-container" class="max-w-7xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
        <!-- Header -->
        <header class="bg-gradient-to-r from-red-500 to-orange-400 text-white p-6 sm:p-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold mb-2 text-shadow">ğŸŒŸ 3í•™ë…„ ì¹­ì°¬ìŠ¤í‹°ì»¤íŒ ğŸŒŸ</h1>
            <p class="text-base sm:text-lg text-red-100">ë§¤ë‹¬ ìµœê³ ì˜ ë°˜ê³¼ í•™ìƒì„ ì°¾ì•„ë³´ì„¸ìš”!</p>
        </header>

        <!-- Stats -->
        <div class="flex justify-around bg-gray-100 p-4 sm:p-5 border-b-2 border-gray-200">
            <div class="text-center p-4 bg-white rounded-xl shadow-md min-w-[120px] sm:min-w-[150px]">
                <div id="totalStudents" class="text-3xl font-bold text-red-500">0</div>
                <div class="text-sm text-gray-600 mt-1">ì „ì²´ í•™ìƒ ìˆ˜</div>
            </div>
            <div class="text-center p-4 bg-white rounded-xl shadow-md min-w-[120px] sm:min-w-[150px]">
                <div id="totalStickers" class="text-3xl font-bold text-red-500">0</div>
                <div class="text-sm text-gray-600 mt-1">ì „ì²´ ìŠ¤í‹°ì»¤ ìˆ˜</div>
            </div>
            <div class="text-center p-4 bg-white rounded-xl shadow-md min-w-[120px] sm:min-w-[150px]">
                <div id="topClass" class="text-3xl font-bold text-red-500">-</div>
                <div class="text-sm text-gray-600 mt-1">1ë“± ë°˜</div>
            </div>
        </div>

        <!-- Top Performers -->
        <div class="p-4 sm:p-6">
            <div class="bg-gradient-to-r from-amber-400 to-orange-500 text-white p-6 rounded-2xl text-center shadow-lg">
                <h3 class="mb-4 text-2xl font-bold">ğŸ† ì´ë‹¬ì˜ TOP 3 ğŸ†</h3>
                <div id="topPerformers" class="flex justify-center gap-4 sm:gap-8 flex-wrap">
                    <div class="bg-white/20 p-4 rounded-lg">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>
        </div>

        <!-- Class Tabs -->
        <div class="bg-gray-200 overflow-x-auto">
            <nav id="classTabs" class="flex space-x-2 p-1"></nav>
        </div>

        <!-- Class Content Area -->
        <main id="classContentArea" class="p-4 sm:p-6 bg-gray-50"></main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA AND CONSTANTS ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwbLZvOcMewFsJuGHtu8wpd4C63PoDOUmWc1k45tN7FdHTVrjoV23dH7nARp0u6_AFa4g/exec';
        const studentsData = {
          'class1': [
            { number: 1, name: 'ê°„ë¯¼ì¤€' }, { number: 2, name: 'ê¶Œì˜ˆí•œ' }, { number: 3, name: 'ê¹€ëŒ€í•œ' }, 
            { number: 4, name: 'ê¹€ì„œì •' }, { number: 5, name: 'ê¹€ì„ ìœ¨' }, { number: 6, name: 'ê¹€ìŠ¹ë¯¼' }, 
            { number: 7, name: 'ê¹€ì¬ì›' }, { number: 8, name: 'ê¹€ì •ìˆ˜' }, { number: 9, name: 'ê¹€í•´ì›' }, 
            { number: 10, name: 'ë‚¨ê¶ê±´' }, { number: 11, name: 'ë…¸í˜„ìŠ¹' }, { number: 13, name: 'ë°±ì„œìœ¨' }, 
            { number: 14, name: 'ë³€ì„±í˜„' }, { number: 15, name: 'ì†¡í˜¸ê·¼' }, { number: 16, name: 'ì›ìƒì§„' }, 
            { number: 17, name: 'ìœ ë™ê±´' }, { number: 18, name: 'ìœ¤í˜œì„±' }, { number: 19, name: 'ì´ì‹œìœ¤' }, 
            { number: 20, name: 'ì •ë‹¤ê²€' }, { number: 21, name: 'ìµœê·¼ì°¬' }, { number: 22, name: 'ìµœì‹œìš°' }, 
            { number: 23, name: 'ìµœì‹œí›ˆ' }, { number: 24, name: 'ì¶”ì •ìš°' }, { number: 25, name: 'í•œì¤€í¬' }, 
            { number: 26, name: 'í—ˆë¦¬ì›' }, { number: 27, name: 'í™ì£¼í˜¸' }
          ],
          'class2': [
            { number: 1, name: 'ê°•ë¯¼ì¬' }, { number: 2, name: 'ê²½ë•ê·œ' }, { number: 3, name: 'ê³½ëª…ì„' }, 
            { number: 4, name: 'êµ¬êµì›' }, { number: 5, name: 'ê¶Œìœ ë¹ˆ' }, { number: 6, name: 'ê¹€ì¬ì›…' }, 
            { number: 7, name: 'ê¹€íƒœìˆ˜' }, { number: 8, name: 'ë‚˜ìŠ¹í˜„' }, { number: 9, name: 'ë…¸í•´ì¼' }, 
            { number: 10, name: 'ë°•ê±´íœ˜' }, { number: 11, name: 'ë°•ì†¡ìš°' }, { number: 12, name: 'ì†¡ì¸ì—½' }, 
            { number: 13, name: 'ì•ˆì¬í™' }, { number: 14, name: 'ìœ¤ì„œì§„' }, { number: 15, name: 'ì´ìƒì¤€' }, 
            { number: 16, name: 'ì´ìˆ˜í•œ' }, { number: 17, name: 'ì´ìŠ¹í˜„' }, { number: 18, name: 'ì •ìš°ì§„' }, 
            { number: 20, name: 'ì§€ì„±ì •' }, { number: 21, name: 'ì§„ì—°ìš°' }, { number: 22, name: 'ì°¨ìœ¤í˜¸' }, 
            { number: 23, name: 'ì°¨ì€ì°¬' }, { number: 24, name: 'ìµœì¬ìš°' }, { number: 25, name: 'ìµœí˜¸ì˜' }, 
            { number: 26, name: 'í•˜ì„ì£¼' }, { number: 27, name: 'ê¹€ë™í˜' }
          ],
          'class3': [
            { number: 1, name: 'ê¸¸ì„±í˜¸' }, { number: 2, name: 'ê¹€ë¯¼ì¤€' }, { number: 3, name: 'ê¹€ì˜ì¤€' }, 
            { number: 4, name: 'ê¹€ì¬ì‹ ' }, { number: 5, name: 'ë‚¨ìŠ¹ì°¬' }, { number: 6, name: 'ë¬¸ì£¼í™˜' }, 
            { number: 7, name: 'ë¯¼ì •ê¸°' }, { number: 8, name: 'ë°•ì€ì°¬' }, { number: 9, name: 'ë°•ì£¼í˜' }, 
            { number: 10, name: 'ì†ì˜ì² ' }, { number: 11, name: 'ì†ì •í›ˆ' }, { number: 12, name: 'ì†¡ë¯¼ì œ' }, 
            { number: 13, name: 'ì‹¬ìš°ì£¼' }, { number: 14, name: 'ì›ì¤€í˜' }, { number: 15, name: 'ì´ë‚™ì—°' }, 
            { number: 16, name: 'ì´í•˜ìœ¤' }, { number: 17, name: 'ì¥ì„±ìš±' }, { number: 18, name: 'ì „ë„ìœ¤' }, 
            { number: 19, name: 'ì •ëª…í›ˆ' }, { number: 20, name: 'ì •ì„œí›„' }, { number: 21, name: 'ì •ì§„ì„­' }, 
            { number: 22, name: 'ì£¼í˜„ìš°' }, { number: 23, name: 'ìµœë¯¼ì¤€' }, { number: 24, name: 'ìµœìš°ì§„' }, 
            { number: 25, name: 'ìµœì¸ìš°' }, { number: 26, name: 'í•œê²°' }
          ],
          'class4': [
            { number: 1, name: 'ê¶Œì§€í›„' }, { number: 2, name: 'ê¹€ë™í›„' }, { number: 3, name: 'ê¹€ë¯¼ê¸°' }, 
            { number: 4, name: 'ê¹€ìœ ë˜' }, { number: 5, name: 'ê¹€ì£¼ì˜' }, { number: 6, name: 'ê¹€ì£¼í™˜' }, 
            { number: 7, name: 'ê¹€ì¤€í˜' }, { number: 8, name: 'ë¬¸ì •í™˜' }, { number: 9, name: 'ë°•ê±´í˜¸' }, 
            { number: 10, name: 'ë°•ë¯¼ì°¬' }, { number: 11, name: 'ì„œìœ¤ê±´' }, { number: 12, name: 'ì›íƒœì—°' }, 
            { number: 13, name: 'ì´ë™ê·œ' }, { number: 14, name: 'ì´ë£¨ë‹¤' }, { number: 15, name: 'ì´ì—°ìˆ˜' }, 
            { number: 16, name: 'ì´ì •ë¯¼' }, { number: 17, name: 'ì´ì •í˜‘' }, { number: 18, name: 'ì´í•˜ìœ¨' }, 
            { number: 19, name: 'ìµœëª…ê·œ' }, { number: 20, name: 'ìµœë¯¼ì¤€' }, { number: 21, name: 'ìµœìœ¤ëª¨' }, 
            { number: 22, name: 'ìµœìœ¤í˜¸' }, { number: 23, name: 'ìµœì¤€ìš°' }, { number: 24, name: 'í•˜ì •ë¯¼' }, 
            { number: 25, name: 'í—ˆì„±ë¹ˆ' }, { number: 26, name: 'í™í˜„ìš°' }
          ],
          'class5': [
            { number: 1, name: 'ê°•ìŠ¹ìœ¤' }, { number: 2, name: 'ê¶Œê¸°í™˜' }, { number: 3, name: 'ê¸¸ì°¬í˜¸' }, 
            { number: 4, name: 'ê¹€ë¬¸ì›' }, { number: 5, name: 'ê¹€ìœ¤í˜¸' }, { number: 6, name: 'ê¹€ì •í›„' }, 
            { number: 7, name: 'ê¹€í˜¸ì¸' }, { number: 8, name: 'ë¬¸í˜„ì„±' }, { number: 9, name: 'ë°•ëª…ì¬' }, 
            { number: 10, name: 'ë°•ìƒì§„' }, { number: 11, name: 'ì‹¬ë¬¸ìˆ˜' }, { number: 12, name: 'ìœ ì§€ì„±' }, 
            { number: 13, name: 'ì´ì„œìš°' }, { number: 14, name: 'ì´ì‹œí›„' }, { number: 15, name: 'ì´ìœ¤ìˆ˜' }, 
            { number: 16, name: 'ì´ì¶©ì›' }, { number: 17, name: 'ì´í˜„ë„' }, { number: 18, name: 'ì´íš¨ì›' }, 
            { number: 19, name: 'ì„ì •ë¬µ' }, { number: 20, name: 'ì¥ì¤€ê·œ' }, { number: 21, name: 'ì •ì§€í™˜' }, 
            { number: 22, name: 'ìµœê·¼ìš°' }, { number: 23, name: 'ìµœì€í˜' }, { number: 24, name: 'ìµœíƒœì˜' }, 
            { number: 25, name: 'í—ˆì€ì„±' }, { number: 26, name: 'í™í•´ì†”' }
          ],
          'class6': [
            { number: 1, name: 'ê°•ì§€í˜¸' }, { number: 2, name: 'ê¹€ê´€í˜•' }, { number: 3, name: 'ê¹€ë¯¼ì„±' }, 
            { number: 4, name: 'ê¹€ë¯¼ì¤€' }, { number: 5, name: 'ê¹€ì •ìš°' }, { number: 6, name: 'ê¹€ì£¼ì›' }, 
            { number: 7, name: 'ê¹€ì¤€ìˆ˜' }, { number: 8, name: 'ê¹€í˜•ê²½' }, { number: 9, name: 'ì„œì•„í˜„' }, 
            { number: 10, name: 'ì„œì°¬ì„±' }, { number: 11, name: 'ì†¡ì˜ˆì¤€' }, { number: 12, name: 'ì‹ ì€ìˆ˜' }, 
            { number: 13, name: 'ì‹¬ìš°ì§„' }, { number: 14, name: 'ìœ¤ì„¸ìœ¤' }, { number: 15, name: 'ì´ê°€ëŒ' }, 
            { number: 16, name: 'ì´ë™ê¶Œ' }, { number: 17, name: 'ì´ë™ì„ ' }, { number: 18, name: 'ì´ìœ¨ë¯¼' }, 
            { number: 19, name: 'ì´ì¤€ë¯¼' }, { number: 20, name: 'ì´í˜¸í˜„' }, { number: 21, name: 'ì„ì¢…í˜„' }, 
            { number: 22, name: 'ì¥ë¯¼' }, { number: 23, name: 'ì¥í˜„í˜¸' }, { number: 24, name: 'ì •ë¯¼í˜' }, 
            { number: 25, name: 'ì¡°í•˜ëŒ' }, { number: 26, name: 'ìµœê·œí™”' }
          ]
        };

        // --- STATE VARIABLES ---
        let scores = {};
        let memos = {};
        let activeClassKey = 'class1';

        // --- DOM ELEMENTS ---
        const classTabsContainer = document.getElementById('classTabs');
        const classContentArea = document.getElementById('classContentArea');

        // --- DATA PERSISTENCE ---
        const loadData = () => {
            try {
                scores = JSON.parse(localStorage.getItem('studentScores') || '{}');
                memos = JSON.parse(localStorage.getItem('studentMemos') || '{}');
            } catch (e) {
                console.error("Failed to load data from localStorage", e);
                scores = {};
                memos = {};
            }
        };

        const saveData = () => {
            try {
                localStorage.setItem('studentScores', JSON.stringify(scores));
                localStorage.setItem('studentMemos', JSON.stringify(memos));
            } catch (e) {
                console.error("Failed to save data to localStorage", e);
            }
        };
        
        window.addEventListener('beforeunload', saveData);
        setInterval(saveData, 5000); // Save every 5 seconds as a fallback

        // --- RENDERING LOGIC ---
        const getStars = (currentScore) => {
            if (currentScore <= 0) return 'ğŸŒ±';
            const stars = 'â­'.repeat(Math.min(currentScore, 10));
            return stars + (currentScore > 10 ? `+${currentScore - 10}` : '');
        };

        const createStudentCardHTML = (student, classNum) => {
            const classKey = `class${classNum}`;
            const studentKey = `${classKey}-${student.number}`;
            const score = scores[studentKey] || 0;
            const studentMemos = memos[studentKey] || [];

            const memosHTML = studentMemos.length > 0 
                ? studentMemos.slice().reverse().slice(0, 3).map(memo => `
                    <div class="p-2 rounded-md text-xs ${memo.change > 0 ? 'bg-blue-50 border-l-4 border-blue-400' : 'bg-red-50 border-l-4 border-red-400'}">
                        <p class="font-semibold text-gray-700">
                            <span class="${memo.change > 0 ? 'text-blue-600' : 'text-red-600'}">
                                ${memo.change > 0 ? `+${memo.change}` : memo.change}ì 
                            </span>
                            : ${memo.text}
                        </p>
                        <p class="text-gray-500 text-right mt-1">${memo.date}</p>
                    </div>
                `).join('')
                : `<p class="text-xs text-center text-gray-400 pt-2">ë©”ëª¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;

            return `
                <div id="card-${studentKey}" class="bg-white rounded-2xl p-5 shadow-lg border-2 border-transparent hover:border-red-400 hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">${student.name}</h3>
                        <span class="bg-purple-100 text-purple-700 text-xs font-bold px-3 py-1 rounded-full">${student.number}ë²ˆ</span>
                    </div>

                    <div class="flex items-center justify-between mb-4 bg-gray-50 p-3 rounded-lg">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl" title="${score}ì ">${getStars(score)}</div>
                            <div class="text-3xl font-bold text-red-500">${score}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="handleScoreChange(${classNum}, ${student.number}, 1)" class="w-10 h-10 flex items-center justify-center rounded-full bg-gradient-to-br from-green-400 to-cyan-500 text-white font-bold text-xl shadow-md hover:scale-110 transition-transform duration-200" aria-label="ì ìˆ˜ ì¶”ê°€">+</button>
                            <button onclick="handleScoreChange(${classNum}, ${student.number}, -1)" class="w-10 h-10 flex items-center justify-center rounded-full bg-gradient-to-br from-red-500 to-orange-500 text-white font-bold text-xl shadow-md hover:scale-110 transition-transform duration-200" aria-label="ì ìˆ˜ ê°ì†Œ">-</button>
                        </div>
                    </div>

                    <div>
                        <input type="text" id="memo-${studentKey}" placeholder="ì ìˆ˜ ë³€ê²½ ì´ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm focus:outline-none focus:border-blue-400 transition-colors" />
                        <div class="mt-3 space-y-2 max-h-32 overflow-y-auto pr-2 custom-scrollbar">${memosHTML}</div>
                    </div>
                </div>
            `;
        };

        const renderClassView = (classKey) => {
            const classNum = parseInt(classKey.replace('class', ''), 10);
            const students = studentsData[classKey];
            const classTotal = students.reduce((total, student) => total + (scores[`${classKey}-${student.number}`] || 0), 0);

            const studentCardsHTML = students.map(student => createStudentCardHTML(student, classNum)).join('');
            
            classContentArea.innerHTML = `
                <div>
                    <header class="flex flex-wrap gap-4 justify-between items-center mb-6 p-4 sm:p-5 bg-gradient-to-r from-blue-500 to-cyan-400 text-white rounded-xl shadow-md">
                        <div class="flex-grow">
                            <h2 class="text-2xl font-bold">3í•™ë…„ ${classNum}ë°˜</h2>
                            <div class="text-xl font-semibold">ë°˜ ì´í•©: <span class="font-bold">${classTotal}</span>ì </div>
                        </div>
                        <div class="flex flex-col items-end">
                            <button id="exportBtn-${classNum}" onclick="handleExport(${classNum})" class="flex items-center gap-2 bg-white text-blue-600 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-100 transition-all duration-300 disabled:opacity-50 disabled:cursor-wait">
                                <i class="fas fa-file-export"></i>
                                <span>ì‹œíŠ¸ë¡œ ë‚´ë³´ë‚´ê¸°</span>
                            </button>
                            <p id="exportMsg-${classNum}" class="text-xs mt-2 text-white bg-black/20 px-2 py-1 rounded h-6"></p>
                        </div>
                    </header>
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
                        ${studentCardsHTML}
                    </div>
                </div>
            `;
        };

        const renderTabs = () => {
            classTabsContainer.innerHTML = Object.keys(studentsData).map(key => {
                const classNum = key.replace('class', '');
                const isActive = key === activeClassKey;
                return `
                    <button
                        onclick="showClass('${key}')"
                        class="tab-btn py-3 px-4 sm:px-6 font-bold text-sm sm:text-base rounded-lg transition-all duration-300 whitespace-nowrap ${
                            isActive
                                ? 'bg-white text-red-500 shadow-sm'
                                : 'bg-transparent text-gray-600 hover:bg-white/60'
                        }"
                        data-key="${key}"
                    >
                        3í•™ë…„ ${classNum}ë°˜
                    </button>
                `;
            }).join('');
        };
        
        // --- UPDATE DISPLAY ---
        const updateStats = () => {
            let totalStickers = 0;
            const classTotals = {};
            let totalStudents = 0;

            for (const classKey in studentsData) {
                const classNum = classKey.replace('class', '');
                let classTotal = 0;
                totalStudents += studentsData[classKey].length;
                for (const student of studentsData[classKey]) {
                    const score = scores[`${classKey}-${student.number}`] || 0;
                    totalStickers += score;
                    classTotal += score;
                }
                classTotals[classNum] = classTotal;
            }

            const topClassNum = Object.keys(classTotals).length > 0
                ? Object.keys(classTotals).reduce((a, b) => classTotals[a] > classTotals[b] ? a : b)
                : null;
            
            const topClass = topClassNum && classTotals[topClassNum] > 0 ? `3-${topClassNum}ë°˜` : '-';

            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalStickers').textContent = totalStickers;
            document.getElementById('topClass').textContent = topClass;
        };

        const updateTopPerformers = () => {
            const allStudentsWithScores = [];
            for (const classKey in studentsData) {
                const classNum = classKey.replace('class', '');
                for (const student of studentsData[classKey]) {
                    const score = scores[`${classKey}-${student.number}`] || 0;
                    if (score > 0) {
                        allStudentsWithScores.push({
                            ...student,
                            score,
                            classNum: Number(classNum),
                        });
                    }
                }
            }

            allStudentsWithScores.sort((a, b) => b.score - a.score);
            const top3 = allStudentsWithScores.slice(0, 3);
            const crowns = ['ğŸ‘‘', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            const topPerformersEl = document.getElementById('topPerformers');
            
            if (top3.length > 0) {
                topPerformersEl.innerHTML = top3.map((student, idx) => `
                    <div class="bg-white/20 p-4 rounded-lg backdrop-blur-sm transform hover:scale-105 transition-transform duration-300">
                        <div class="text-3xl mb-1">${crowns[idx]}</div>
                        <div class="font-bold text-lg">${student.name}</div>
                        <div class="text-sm opacity-90">3-${student.classNum}ë°˜ ${student.number}ë²ˆ</div>
                        <div class="text-base mt-1">${student.score}ì  â­</div>
                    </div>
                `).join('');
            } else {
                topPerformersEl.innerHTML = `<div class="bg-white/20 p-4 rounded-lg">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>`;
            }
        };

        const updateAll = () => {
            updateStats();
            updateTopPerformers();
            renderTabs();
            renderClassView(activeClassKey);
        };
        
        // --- EVENT HANDLERS ---
        window.showClass = (classKey) => {
            activeClassKey = classKey;
            // Update tab styles
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.dataset.key === activeClassKey) {
                    btn.classList.add('bg-white', 'text-red-500', 'shadow-sm');
                    btn.classList.remove('bg-transparent', 'text-gray-600', 'hover:bg-white/60');
                } else {
                    btn.classList.remove('bg-white', 'text-red-500', 'shadow-sm');
                    btn.classList.add('bg-transparent', 'text-gray-600', 'hover:bg-white/60');
                }
            });
            renderClassView(activeClassKey);
        };
        
        window.handleScoreChange = (classNum, studentNum, change) => {
            const classKey = `class${classNum}`;
            const studentKey = `${classKey}-${studentNum}`;
            const memoInput = document.getElementById(`memo-${studentKey}`);
            const memoText = memoInput.value.trim();

            scores[studentKey] = (scores[studentKey] || 0) + change;

            if (memoText) {
                if (!memos[studentKey]) {
                    memos[studentKey] = [];
                }
                memos[studentKey].push({
                    date: new Date().toLocaleString('ko-KR'),
                    text: memoText,
                    change: change,
                    recorder: 'ì„ ìƒë‹˜'
                });
            }
            
            memoInput.value = '';
            updateAll(); // Re-render everything to show changes
        };

        window.handleExport = async (classNum) => {
            const exportBtn = document.getElementById(`exportBtn-${classNum}`);
            const btnText = exportBtn.querySelector('span');
            const exportMsg = document.getElementById(`exportMsg-${classNum}`);
            
            if (!GOOGLE_SCRIPT_URL) {
                alert('Google Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            exportBtn.disabled = true;
            btnText.textContent = 'ë‚´ë³´ë‚´ëŠ” ì¤‘...';
            exportMsg.textContent = '';

            const classKey = `class${classNum}`;
            const students = studentsData[classKey];
            const records = [];
            students.forEach(student => {
                const studentKey = `${classKey}-${student.number}`;
                const studentMemos = memos[studentKey] || [];
                studentMemos.forEach(memo => {
                    records.push({
                        ...memo,
                        studentName: student.name,
                        studentNumber: student.number,
                    });
                });
            });

            if (records.length === 0) {
                exportMsg.textContent = 'ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                exportBtn.disabled = false;
                btnText.textContent = 'ì‹œíŠ¸ë¡œ ë‚´ë³´ë‚´ê¸°';
                setTimeout(() => { exportMsg.textContent = ''; }, 3000);
                return;
            }

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        className: `3í•™ë…„ ${classNum}ë°˜`,
                        records: records,
                    }),
                });

                if (!response.ok) throw new Error(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${response.statusText}`);

                const result = await response.json();
                if (result.status === 'success') {
                    exportMsg.textContent = result.message;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error exporting data:', error);
                exportMsg.textContent = `ì˜¤ë¥˜: ${error.message}`;
            } finally {
                exportBtn.disabled = false;
                btnText.textContent = 'ì‹œíŠ¸ë¡œ ë‚´ë³´ë‚´ê¸°';
                setTimeout(() => { exportMsg.textContent = ''; }, 7000);
            }
        };

        // --- INITIALIZATION ---
        const init = () => {
            loadData();
            updateAll();
        };

        init();
    });
    </script>
</body>
</html>
