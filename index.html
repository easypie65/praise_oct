<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3í•™ë…„ ì¹­ì°¬ìŠ¤í‹°ì»¤íŒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header-controls {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .header-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.2);
            color: white;
            backdrop-filter: blur(5px);
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.4);
            transform: translateY(-2px);
        }

        .header-btn.reset {
            background: #c23616;
        }
        
        .header-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 3px solid #e9ecef;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-width: 150px;
            flex: 1;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #ff6b6b;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .class-tabs {
            display: flex;
            background: #e9ecef;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1.1em;
            font-weight: bold;
            color: #666;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab.active {
            background: white;
            color: #ff6b6b;
            border-bottom: 3px solid #ff6b6b;
        }

        .tab:hover {
            background: #f8f9fa;
        }

        .class-content {
            padding: 30px;
            display: none;
        }

        .class-content.active {
            display: block;
        }

        .class-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border-radius: 15px;
        }
        
        .class-header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .class-export-btn {
            padding: 8px 15px;
            font-size: 0.9em;
            background: rgba(255,255,255,0.15) !important;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .class-export-btn:hover {
            background: rgba(255,255,255,0.3) !important;
        }


        .class-title {
            font-size: 1.8em;
            font-weight: bold;
        }

        .class-total {
            font-size: 1.5em;
            font-weight: bold;
            background: rgba(0,0,0,0.1);
            padding: 5px 15px;
            border-radius: 10px;
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .student-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .student-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            border-color: #ff6b6b;
        }

        .student-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .student-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #2d3436;
        }

        .student-number {
            background: #ddd6fe;
            color: #7c3aed;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .score-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .score-display {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stars {
            color: #ffd700;
            font-size: 1.5em;
        }

        .score-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #ff6b6b;
        }

        .score-controls {
            display: flex;
            gap: 10px;
        }

        .score-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .score-btn.plus {
            background: linear-gradient(135deg, #00b894, #00a085);
        }

        .score-btn.minus {
            background: linear-gradient(135deg, #e17055, #d63031);
        }

        .score-btn:hover {
            transform: scale(1.1);
        }

        .memo-section {
            margin-top: 15px;
        }

        .memo-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 0.9em;
            transition: border-color 0.3s ease;
        }

        .memo-input:focus {
            outline: none;
            border-color: #74b9ff;
        }

        .memo-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .memo-item {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 5px;
            font-size: 0.85em;
            border-left: 3px solid #74b9ff;
        }
        
        .memo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .memo-delete-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.2em;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
        }

        .memo-delete-btn:hover {
            color: #d63031;
        }

        .memo-item.negative {
            border-left-color: #e17055;
        }

        .memo-date {
            color: #666;
            font-size: 0.8em;
        }

        .memo-text {
            margin-top: 3px;
        }

        .top-performers {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 15px;
            text-align: center;
        }

        .top-performers h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .top-list {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .top-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            min-width: 150px;
        }

        .crown {
            font-size: 2em;
            margin-bottom: 5px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover,
        .modal-close:focus {
            color: black;
            text-decoration: none;
        }

        #modal-title {
            margin-bottom: 15px;
            font-size: 1.5em;
            color: #333;
        }

        #modal-message {
            margin-bottom: 20px;
            font-size: 1em;
            color: #666;
            line-height: 1.5;
            text-align: left;
        }

        #modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 1em;
        }

        .modal-actions {
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-btn.confirm {
            background: #ff6b6b;
            color: white;
        }
        .modal-btn.confirm:hover {
            background: #ee5a24;
        }

        .modal-btn.cancel {
            background: #e9ecef;
            color: #333;
        }
        .modal-btn.cancel:hover {
            background: #ced4da;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .students-grid {
                grid-template-columns: 1fr;
            }
            
            .class-tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex-grow: 1;
                min-width: 100px;
            }
            
            .top-list {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒŸ 3í•™ë…„ ì¹­ì°¬ìŠ¤í‹°ì»¤íŒ ğŸŒŸ</h1>
            <p>ë§¤ë‹¬ ìµœê³ ì˜ ë°˜ê³¼ í•™ìƒì„ ì°¾ì•„ë³´ì„¸ìš”!</p>
            <div class="header-controls">
                <button id="exportBtn" class="header-btn">ì „ì²´ ë°ì´í„° ë‚´ë³´ë‚´ê¸° ğŸš€</button>
                <button id="settingsBtn" class="header-btn">ì„¤ì • âš™ï¸</button>
                <button id="resetBtn" class="header-btn reset">ì „ì²´ ì´ˆê¸°í™” âš ï¸</button>
            </div>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="totalStudents">0</div>
                <div class="stat-label">ì „ì²´ í•™ìƒ ìˆ˜</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalStickers">0</div>
                <div class="stat-label">ì „ì²´ ìŠ¤í‹°ì»¤ ìˆ˜</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="topClass">-</div>
                <div class="stat-label">1ë“± ë°˜</div>
            </div>
        </div>

        <div class="top-performers">
            <h3>ğŸ† ì´ë‹¬ì˜ TOP 3 ğŸ†</h3>
            <div class="top-list" id="topPerformers">
                <div class="top-item">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
        </div>

        <div class="class-tabs" id="classTabsContainer">
            <!-- Tabs will be dynamically generated here -->
        </div>

        <div id="classContentContainer">
            <!-- Class content will be dynamically generated here -->
        </div>
    </div>
    
    <div id="customModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2 id="modal-title"></h2>
            <div id="modal-message"></div>
            <input type="text" id="modal-input" placeholder="">
            <div class="modal-actions">
                <button id="modal-cancel-btn" class="modal-btn cancel">ì·¨ì†Œ</button>
                <button id="modal-confirm-btn" class="modal-btn confirm">í™•ì¸</button>
            </div>
        </div>
    </div>

    <script>
        const studentsData = {
            class1: [
                {number: 1, name: 'ê°„ë¯¼ì¤€'}, {number: 2, name: 'ê¶Œì˜ˆí•œ'}, {number: 3, name: 'ê¹€ëŒ€í•œ'}, 
                {number: 4, name: 'ê¹€ì„œì •'}, {number: 5, name: 'ê¹€ì„ ìœ¨'}, {number: 6, name: 'ê¹€ìŠ¹ë¯¼'}, 
                {number: 7, name: 'ê¹€ì¬ì›'}, {number: 8, name: 'ê¹€ì •ìˆ˜'}, {number: 9, name: 'ê¹€í•´ì›'}, 
                {number: 10, name: 'ë‚¨ê¶ê±´'}, {number: 11, name: 'ë…¸í˜„ìŠ¹'}, {number: 13, name: 'ë°±ì„œìœ¨'}, 
                {number: 14, name: 'ë³€ì„±í˜„'}, {number: 15, name: 'ì†¡í˜¸ê·¼'}, {number: 16, name: 'ì›ìƒì§„'}, 
                {number: 17, name: 'ìœ ë™ê±´'}, {number: 18, name: 'ìœ¤í˜œì„±'}, {number: 19, name: 'ì´ì‹œìœ¤'}, 
                {number: 20, name: 'ì •ë‹¤ê²€'}, {number: 21, name: 'ìµœê·¼ì°¬'}, {number: 22, name: 'ìµœì‹œìš°'}, 
                {number: 23, name: 'ìµœì‹œí›ˆ'}, {number: 24, name: 'ì¶”ì •ìš°'}, {number: 25, name: 'í•œì¤€í¬'}, 
                {number: 26, name: 'í—ˆë¦¬ì›'}, {number: 27, name: 'í™ì£¼í˜¸'}
            ],
            class2: [
                {number: 1, name: 'ê°•ë¯¼ì¬'}, {number: 2, name: 'ê²½ë•ê·œ'}, {number: 3, name: 'ê³½ëª…ì„'}, 
                {number: 4, name: 'êµ¬êµì›'}, {number: 5, name: 'ê¶Œìœ ë¹ˆ'}, {number: 6, name: 'ê¹€ì¬ì›…'}, 
                {number: 7, name: 'ê¹€íƒœìˆ˜'}, {number: 8, name: 'ë‚˜ìŠ¹í˜„'}, {number: 9, name: 'ë…¸í•´ì¼'}, 
                {number: 10, name: 'ë°•ê±´íœ˜'}, {number: 11, name: 'ë°•ì†¡ìš°'}, {number: 12, name: 'ì†¡ì¸ì—½'}, 
                {number: 13, name: 'ì•ˆì¬í™'}, {number: 14, name: 'ìœ¤ì„œì§„'}, {number: 15, name: 'ì´ìƒì¤€'}, 
                {number: 16, name: 'ì´ìˆ˜í•œ'}, {number: 17, name: 'ì´ìŠ¹í˜„'}, {number: 18, name: 'ì •ìš°ì§„'}, 
                {number: 20, name: 'ì§€ì„±ì •'}, {number: 21, name: 'ì§„ì—°ìš°'}, {number: 22, name: 'ì°¨ìœ¤í˜¸'}, 
                {number: 23, name: 'ì°¨ì€ì°¬'}, {number: 24, name: 'ìµœì¬ìš°'}, {number: 25, name: 'ìµœí˜¸ì˜'}, 
                {number: 26, name: 'í•˜ì„ì£¼'}, {number: 27, name: 'ê¹€ë™í˜'}
            ],
            class3: [
                {number: 1, name: 'ê¸¸ì„±í˜¸'}, {number: 2, name: 'ê¹€ë¯¼ì¤€'}, {number: 3, name: 'ê¹€ì˜ì¤€'}, 
                {number: 4, name: 'ê¹€ì¬ì‹ '}, {number: 5, name: 'ë‚¨ìŠ¹ì°¬'}, {number: 6, name: 'ë¬¸ì£¼í™˜'}, 
                {number: 7, name: 'ë¯¼ì •ê¸°'}, {number: 8, name: 'ë°•ì€ì°¬'}, {number: 9, name: 'ë°•ì£¼í˜'}, 
                {number: 10, name: 'ì†ì˜ì² '}, {number: 11, name: 'ì†ì •í›ˆ'}, {number: 12, name: 'ì†¡ë¯¼ì œ'}, 
                {number: 13, name: 'ì‹¬ìš°ì£¼'}, {number: 14, name: 'ì›ì¤€í˜'}, {number: 15, name: 'ì´ë‚™ì—°'}, 
                {number: 16, name: 'ì´í•˜ìœ¤'}, {number: 17, name: 'ì¥ì„±ìš±'}, {number: 18, name: 'ì „ë„ìœ¤'}, 
                {number: 19, name: 'ì •ëª…í›ˆ'}, {number: 20, name: 'ì •ì„œí›„'}, {number: 21, name: 'ì •ì§„ì„­'}, 
                {number: 22, name: 'ì£¼í˜„ìš°'}, {number: 23, name: 'ìµœë¯¼ì¤€'}, {number: 24, name: 'ìµœìš°ì§„'}, 
                {number: 25, name: 'ìµœì¸ìš°'}, {number: 26, name: 'í•œê²°'}
            ],
            class4: [
                {number: 1, name: 'ê¶Œì§€í›„'}, {number: 2, name: 'ê¹€ë™í›„'}, {number: 3, name: 'ê¹€ë¯¼ê¸°'}, 
                {number: 4, name: 'ê¹€ìœ ë˜'}, {number: 5, name: 'ê¹€ì£¼ì˜'}, {number: 6, name: 'ê¹€ì£¼í™˜'}, 
                {number: 7, name: 'ê¹€ì¤€í˜'}, {number: 8, name: 'ë¬¸ì •í™˜'}, {number: 9, name: 'ë°•ê±´í˜¸'}, 
                {number: 10, name: 'ë°•ë¯¼ì°¬'}, {number: 11, name: 'ì„œìœ¤ê±´'}, {number: 12, name: 'ì›íƒœì—°'}, 
                {number: 13, name: 'ì´ë™ê·œ'}, {number: 14, name: 'ì´ë£¨ë‹¤'}, {number: 15, name: 'ì´ì—°ìˆ˜'}, 
                {number: 16, name: 'ì´ì •ë¯¼'}, {number: 17, name: 'ì´ì •í˜‘'}, {number: 18, name: 'ì´í•˜ìœ¨'}, 
                {number: 19, name: 'ìµœëª…ê·œ'}, {number: 20, name: 'ìµœë¯¼ì¤€'}, {number: 21, name: 'ìµœìœ¤ëª¨'}, 
                {number: 22, name: 'ìµœìœ¤í˜¸'}, {number: 23, name: 'ìµœì¤€ìš°'}, {number: 24, name: 'í•˜ì •ë¯¼'}, 
                {number: 25, name: 'í—ˆì„±ë¹ˆ'}, {number: 26, name: 'í™í˜„ìš°'}
            ],
            class5: [
                {number: 1, name: 'ê°•ìŠ¹ìœ¤'}, {number: 2, name: 'ê¶Œê¸°í™˜'}, {number: 3, name: 'ê¸¸ì°¬í˜¸'}, 
                {number: 4, name: 'ê¹€ë¬¸ì›'}, {number: 5, name: 'ê¹€ìœ¤í˜¸'}, {number: 6, name: 'ê¹€ì •í›„'}, 
                {number: 7, name: 'ê¹€í˜¸ì¸'}, {number: 8, name: 'ë¬¸í˜„ì„±'}, {number: 9, name: 'ë°•ëª…ì¬'}, 
                {number: 10, name: 'ë°•ìƒì§„'}, {number: 11, name: 'ì‹¬ë¬¸ìˆ˜'}, {number: 12, name: 'ìœ ì§€ì„±'}, 
                {number: 13, name: 'ì´ì„œìš°'}, {number: 14, name: 'ì´ì‹œí›„'}, {number: 15, name: 'ì´ìœ¤ìˆ˜'}, 
                {number: 16, name: 'ì´ì¶©ì›'}, {number: 17, name: 'ì´í˜„ë„'}, {number: 18, name: 'ì´íš¨ì›'}, 
                {number: 19, name: 'ì„ì •ë¬µ'}, {number: 20, name: 'ì¥ì¤€ê·œ'}, {number: 21, name: 'ì •ì§€í™˜'}, 
                {number: 22, name: 'ìµœê·¼ìš°'}, {number: 23, name: 'ìµœì€í˜'}, {number: 24, name: 'ìµœíƒœì˜'}, 
                {number: 25, name: 'í—ˆì€ì„±'}, {number: 26, name: 'í™í•´ì†”'}
            ],
            class6: [
                {number: 1, name: 'ê°•ì§€í˜¸'}, {number: 2, name: 'ê¹€ê´€í˜•'}, {number: 3, name: 'ê¹€ë¯¼ì„±'}, 
                {number: 4, name: 'ê¹€ë¯¼ì¤€'}, {number: 5, name: 'ê¹€ì •ìš°'}, {number: 6, name: 'ê¹€ì£¼ì›'}, 
                {number: 7, name: 'ê¹€ì¤€ìˆ˜'}, {number: 8, name: 'ê¹€í˜•ê²½'}, {number: 9, name: 'ì„œì•„í˜„'}, 
                {number: 10, name: 'ì„œì°¬ì„±'}, {number: 11, name: 'ì†¡ì˜ˆì¤€'}, {number: 12, name: 'ì‹ ì€ìˆ˜'}, 
                {number: 13, name: 'ì‹¬ìš°ì§„'}, {number: 14, name: 'ìœ¤ì„¸ìœ¤'}, {number: 15, name: 'ì´ê°€ëŒ'}, 
                {number: 16, name: 'ì´ë™ê¶Œ'}, {number: 17, name: 'ì´ë™ì„ '}, {number: 18, name: 'ì´ìœ¨ë¯¼'}, 
                {number: 19, name: 'ì´ì¤€ë¯¼'}, {number: 20, name: 'ì´í˜¸í˜„'}, {number: 21, name: 'ì„ì¢…í˜„'}, 
                {number: 22, name: 'ì¥ë¯¼'}, {number: 23, name: 'ì¥í˜„í˜¸'}, {number: 24, name: 'ì •ë¯¼í˜'}, 
                {number: 25, name: 'ì¡°í•˜ëŒ'}, {number: 26, 'name': 'ìµœê·œí™”'}
            ]
        };

        let studentScores = {};
        let studentMemos = {};

        function showModal(config) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const titleEl = document.getElementById('modal-title');
                const messageEl = document.getElementById('modal-message');
                const inputEl = document.getElementById('modal-input');
                const confirmBtn = document.getElementById('modal-confirm-btn');
                const cancelBtn = document.getElementById('modal-cancel-btn');
                const closeBtn = document.querySelector('.modal-close');

                titleEl.textContent = config.title;
                messageEl.innerHTML = config.message;
                
                if (config.showInput) {
                    inputEl.style.display = 'block';
                    inputEl.value = config.initialValue || '';
                    inputEl.placeholder = config.placeholder || '';
                } else {
                    inputEl.style.display = 'none';
                }
                
                modal.style.display = 'block';
                
                const close = (value) => {
                    modal.style.display = 'none';
                    // Clone and replace to remove all event listeners at once
                    confirmBtn.replaceWith(confirmBtn.cloneNode(true));
                    cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                    closeBtn.replaceWith(closeBtn.cloneNode(true));
                    resolve(value);
                };

                document.getElementById('modal-confirm-btn').onclick = () => close(config.showInput ? inputEl.value : true);
                document.getElementById('modal-cancel-btn').onclick = () => close(null);
                document.querySelector('.modal-close').onclick = () => close(null);
                
                window.onclick = (event) => {
                    if (event.target == modal) {
                        close(null);
                    }
                };
            });
        }

        function loadData() {
            try {
                studentScores = JSON.parse(localStorage.getItem('studentScores_v2') || '{}');
                studentMemos = JSON.parse(localStorage.getItem('studentMemos_v2') || '{}');
            } catch (e) {
                console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", e);
                studentScores = {};
                studentMemos = {};
            }
        }

        function saveData() {
            try {
                localStorage.setItem('studentScores_v2', JSON.stringify(studentScores));
                localStorage.setItem('studentMemos_v2', JSON.stringify(studentMemos));
            } catch (e) {
                console.error("ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:", e);
            }
        }

        function getStars(score) {
            const positiveScore = Math.max(0, score);
            return 'â­'.repeat(positiveScore);
        }

        function showClass(className) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.class-content').forEach(content => content.classList.remove('active'));
            
            const targetTab = document.querySelector(`button[onclick="showClass('${className}')"]`);
            if(targetTab) targetTab.classList.add('active');
            
            const targetContent = document.getElementById(className);
            if(targetContent) targetContent.classList.add('active');
        }

        function updateScore(classNum, studentNum, change, memo) {
            const key = `class${classNum}-${studentNum}`;
            
            if (!studentScores[key]) studentScores[key] = 0;
            if (!studentMemos[key]) studentMemos[key] = [];

            studentScores[key] += change;
            
            if (memo && memo.trim()) {
                studentMemos[key].unshift({
                    date: new Date().toLocaleString('ko-KR'),
                    text: memo,
                    change: change,
                    recorder: 'ì„ ìƒë‹˜'
                });
            }

            updateDisplay();
            saveData();
        }

        function updateDisplay() {
            Object.keys(studentsData).forEach(className => {
                const classNum = className.replace('class', '');
                studentsData[className].forEach(student => {
                    updateStudentCard(classNum, student.number);
                });
                updateClassTotal(classNum);
            });
            updateStats();
            updateTopPerformers();
        }

        function updateStudentCard(classNum, studentNum) {
            const key = `class${classNum}-${studentNum}`;
            const score = studentScores[key] || 0;
            const memos = studentMemos[key] || [];

            const scoreEl = document.getElementById(`score-${key}`);
            const starsEl = document.getElementById(`stars-${key}`);
            const memosEl = document.getElementById(`memos-${key}`);

            if (scoreEl) scoreEl.textContent = score;
            if (starsEl) starsEl.textContent = getStars(score);
            
            if (memosEl) {
                memosEl.innerHTML = memos.map((memo, index) => {
                    const sign = memo.change > 0 ? '+' : '';
                    const negClass = memo.change < 0 ? 'negative' : '';
                    return `<div class="memo-item ${negClass}">
                        <div class="memo-header">
                            <div class="memo-date">${memo.date} (${memo.recorder})</div>
                            <button class="memo-delete-btn" onclick="deleteMemo(${classNum}, ${studentNum}, ${index})" title="ë©”ëª¨ ì‚­ì œ">Ã—</button>
                        </div>
                        <div class="memo-text">${sign}${memo.change}ì : ${memo.text}</div>
                    </div>`;
                }).join('');
            }
        }

        function updateClassTotal(classNum) {
            const total = studentsData[`class${classNum}`].reduce((sum, student) => {
                const key = `class${classNum}-${student.number}`;
                return sum + (studentScores[key] || 0);
            }, 0);
            const totalEl = document.getElementById(`class${classNum}-total`);
            if (totalEl) totalEl.textContent = total;
        }

        function updateStats() {
            let totalStickers = 0;
            let classTotals = {};
            let totalStudents = 0;

            Object.keys(studentsData).forEach(className => {
                const classNum = className.replace('class', '');
                totalStudents += studentsData[className].length;
                const classTotal = studentsData[className].reduce((sum, student) => {
                    const score = studentScores[`class${classNum}-${student.number}`] || 0;
                    return sum + score;
                }, 0);
                totalStickers += classTotal;
                classTotals[classNum] = classTotal;
            });

            const topClassNum = Object.keys(classTotals).length > 0 ? 
                                Object.keys(classTotals).reduce((a, b) => classTotals[a] > classTotals[b] ? a : b) : null;
            
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalStickers').textContent = totalStickers;
            document.getElementById('topClass').textContent = topClassNum && classTotals[topClassNum] > 0 ? `3-${topClassNum}ë°˜` : '-';
        }

        function updateTopPerformers() {
            const allStudents = [];
            Object.keys(studentsData).forEach(className => {
                const classNum = className.replace('class', '');
                studentsData[className].forEach(student => {
                    const score = studentScores[`class${classNum}-${student.number}`] || 0;
                    if (score > 0) {
                        allStudents.push({ name: student.name, score, class: classNum, number: student.number });
                    }
                });
            });

            allStudents.sort((a, b) => b.score - a.score);
            const top3 = allStudents.slice(0, 3);
            const crowns = ['ğŸ‘‘', 'ğŸ¥ˆ', 'ğŸ¥‰'];

            const html = top3.length > 0 ? 
                top3.map((student, idx) => `
                    <div class="top-item">
                        <div class="crown">${crowns[idx]}</div>
                        <div><strong>${student.name}</strong></div>
                        <div>3-${student.class}ë°˜ ${student.number}ë²ˆ</div>
                        <div>${student.score}ì  â­</div>
                    </div>
                `).join('') : 
                '<div class="top-item">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';

            document.getElementById('topPerformers').innerHTML = html;
        }

        function createDynamicContent() {
            const tabsContainer = document.getElementById('classTabsContainer');
            const contentContainer = document.getElementById('classContentContainer');
            
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';

            Object.keys(studentsData).forEach((className, index) => {
                const classNum = className.replace('class', '');
                const isActive = index === 0;

                // Create Tab
                const tab = document.createElement('button');
                tab.className = `tab ${isActive ? 'active' : ''}`;
                tab.textContent = `3í•™ë…„ ${classNum}ë°˜`;
                tab.onclick = () => showClass(className);
                tabsContainer.appendChild(tab);
                
                // Create Content
                const contentDiv = document.createElement('div');
                contentDiv.id = className;
                contentDiv.className = `class-content ${isActive ? 'active' : ''}`;
                contentDiv.innerHTML = `
                    <div class="class-header">
                        <div class="class-title">3í•™ë…„ ${classNum}ë°˜</div>
                        <div class="class-header-controls">
                            <button class="header-btn class-export-btn" onclick="exportToSheet(${classNum}, this)">ë‚´ë³´ë‚´ê¸° ğŸš€</button>
                            <div class="class-total">ë°˜ ì´í•©: <span id="${className}-total">0</span>ì </div>
                        </div>
                    </div>
                    <div class="students-grid" id="students-${className}"></div>
                `;
                contentContainer.appendChild(contentDiv);
            });
        }

        function createStudentCards() {
            Object.keys(studentsData).forEach(className => {
                const classNum = className.replace('class', '');
                const container = document.getElementById(`students-${className}`);
                if (!container) return;
                
                container.innerHTML = studentsData[className].map(student => {
                    const key = `class${classNum}-${student.number}`;
                    return `
                        <div class="student-card">
                            <div class="student-info">
                                <div class="student-name">${student.name}</div>
                                <div class="student-number">${student.number}ë²ˆ</div>
                            </div>
                            <div class="score-section">
                                <div class="score-display">
                                    <div class="stars" id="stars-${key}"></div>
                                    <div class="score-number" id="score-${key}">0</div>
                                </div>
                                <div class="score-controls">
                                    <button class="score-btn plus" onclick="addPoint(${classNum}, ${student.number})">+</button>
                                    <button class="score-btn minus" onclick="subtractPoint(${classNum}, ${student.number})">-</button>
                                </div>
                            </div>
                            <div class="memo-section">
                                <input type="text" class="memo-input" placeholder="ì ìˆ˜ ë³€ê²½ ì´ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." id="memo-input-${key}" onkeydown="if(event.key==='Enter') addPoint(${classNum}, ${student.number}, this)">
                                <div class="memo-list" id="memos-${key}"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        function addPoint(classNum, studentNum, inputElement) {
            const key = `class${classNum}-${studentNum}`;
            const memoInput = inputElement || document.getElementById(`memo-input-${key}`);
            const memo = memoInput ? memoInput.value.trim() : '';
            updateScore(classNum, studentNum, 1, memo || 'ì¹­ì°¬');
            if (memoInput) memoInput.value = '';
        }

        async function subtractPoint(classNum, studentNum) {
            const memo = await showModal({
                title: 'ì ìˆ˜ ì°¨ê°',
                message: 'ì ìˆ˜ë¥¼ ì°¨ê°í•˜ëŠ” ì´ìœ ë¥¼ ë°˜ë“œì‹œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.',
                showInput: true,
                placeholder: 'ì´ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”...'
            });
            
            if (memo) {
                updateScore(classNum, studentNum, -1, memo);
            }
        }

        async function deleteMemo(classNum, studentNum, memoIndex) {
            const key = `class${classNum}-${studentNum}`;
            const memos = studentMemos[key];
            if (!memos || !memos[memoIndex]) return;

            const memoToDelete = memos[memoIndex];
            
            const confirmed = await showModal({
                title: 'ë©”ëª¨ ì‚­ì œ í™•ì¸',
                message: `'${memoToDelete.text}' ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì—°ê²°ëœ ì ìˆ˜(${memoToDelete.change > 0 ? '+' : ''}${memoToDelete.change}ì )ë„ í•¨ê»˜ ë³µì›ë©ë‹ˆë‹¤.`,
                showInput: false
            });

            if (confirmed) {
                if (studentScores[key] !== undefined) {
                    studentScores[key] -= memoToDelete.change;
                }
                memos.splice(memoIndex, 1);
                updateDisplay();
                saveData();
            }
        }

        async function resetData() {
            const confirmationText = 'ì´ˆê¸°í™”';
            const userInput = await showModal({
                title: 'âš ï¸ ì „ì²´ ì´ˆê¸°í™”',
                message: `ì •ë§ë¡œ ëª¨ë“  í•™ìƒì˜ ì ìˆ˜ì™€ ë©”ëª¨ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br><br>ê³„ì†í•˜ë ¤ë©´ '<b>${confirmationText}</b>'ë¼ê³  ì…ë ¥í•˜ì„¸ìš”.`,
                showInput: true,
                placeholder: `'${confirmationText}'ë¥¼ ì…ë ¥`
            });
            
            if (userInput === confirmationText) {
                studentScores = {};
                studentMemos = {};
                saveData();
                updateDisplay();
                await showModal({ title: 'ì™„ë£Œ', message: 'ëª¨ë“  ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', showInput: false, });
            } else if (userInput !== null) {
                await showModal({ title: 'ì·¨ì†Œ', message: 'ì…ë ¥ì´ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ì´ˆê¸°í™”ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', showInput: false, });
            }
        }
        
        async function showSettingsModal(promptFirst = false) {
            const currentUrl = localStorage.getItem('webAppUrl');

            let message = `Google Sheetsë¡œ ë‚´ë³´ë‚´ë ¤ë©´ Google Apps Script <b>ì›¹ ì•± URL</b>ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>
                         âœ… URLì€ í•­ìƒ '<b>.../exec</b>'ë¡œ ëë‚˜ì•¼ í•©ë‹ˆë‹¤.<br><br>
                         <b>âš ï¸ ì¤‘ìš”:</b> ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìˆ˜ì •í–ˆë‹¤ë©´, ë°˜ë“œì‹œ 'ë°°í¬' > 'ë°°í¬ ê´€ë¦¬'ì—ì„œ <b>'ìƒˆ ë²„ì „'</b>ìœ¼ë¡œ ì¬ë°°í¬í•˜ê³ , 'ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì'ë¥¼ '<b>ëª¨ë“  ì‚¬ìš©ì</b>'ë¡œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.`;

            if (promptFirst) {
                message = '<strong>ë‚´ë³´ë‚´ê¸°ë¥¼ ê³„ì†í•˜ë ¤ë©´ ë¨¼ì € ì›¹ ì•± URLì„ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.</strong><br><br>' + message;
            }
            
            const newUrl = await showModal({
                title: 'ì‹œíŠ¸ ë‚´ë³´ë‚´ê¸° ì„¤ì •',
                message: message,
                showInput: true,
                placeholder: 'https://script.google.com/macros/s/.../exec',
                initialValue: currentUrl || 'https://script.google.com/macros/s/AKfycbzh7MJLFrfBg18DO2GwFGHwRMYFWoN3Q-Vh12l_AgWMnX_HB4QW8rRy2HmoD6zGIq4ZZQ/exec'
            });

            if (newUrl === null) return null;

            if (newUrl && newUrl.trim() !== '') {
                if (!newUrl.trim().endsWith('/exec')) {
                     await showModal({
                        title: 'âš ï¸ ì˜ëª»ëœ URL',
                        message: `ìœ íš¨í•˜ì§€ ì•Šì€ URL í˜•ì‹ì…ë‹ˆë‹¤. Google Apps Script <b>ì›¹ ì•± ë°°í¬ URL</b>ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.<br><br>
                                  âœ… ì˜¬ë°”ë¥¸ ì£¼ì†ŒëŠ” í•­ìƒ '<b>.../exec</b>'ë¡œ ëë‚©ë‹ˆë‹¤.`,
                        showInput: false,
                    });
                    return null;
                }
                localStorage.setItem('webAppUrl', newUrl.trim());
                await showModal({ title: 'ì €ì¥ ì™„ë£Œ', message: 'ì›¹ ì•± URLì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', showInput: false });
                return newUrl.trim();
            } else if (newUrl !== null) { // User confirmed with empty input
                localStorage.removeItem('webAppUrl');
                await showModal({ title: 'ì‚­ì œ ì™„ë£Œ', message: 'ì›¹ ì•± URLì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', showInput: false });
                return '';
            }
            return null; // User cancelled
        }

        async function exportToSheet(classNum = null, btnElement) {
            let webAppUrl = localStorage.getItem('webAppUrl') || 'https://script.google.com/macros/s/AKfycbzh7MJLFrfBg18DO2GwFGHwRMYFWoN3Q-Vh12l_AgWMnX_HB4QW8rRy2HmoD6zGIq4ZZQ/exec';

            if (!webAppUrl) {
                const newUrl = await showSettingsModal(true);
                 if (newUrl) {
                    webAppUrl = newUrl;
                 } else {
                    return; // User cancelled the settings modal
                 }
            }
            
            const originalBtnHTML = btnElement.innerHTML;
            btnElement.disabled = true;
            btnElement.innerHTML = 'ë‚´ë³´ë‚´ëŠ” ì¤‘...';

            const exportData = [];
            const timestamp = new Date().toLocaleString('ko-KR');
            const targetClasses = classNum ? [`class${classNum}`] : Object.keys(studentsData);
            const sheetName = classNum ? `3í•™ë…„ ${classNum}ë°˜` : 'ì „ì²´ í˜„í™©';


            targetClasses.forEach(className => {
                const currentClassNum = className.replace('class', '');
                studentsData[className].forEach(student => {
                    const key = `class${currentClassNum}-${student.number}`;
                    const score = studentScores[key] || 0;
                    const memos = studentMemos[key] || [];

                    const memoTexts = memos.map(memo => 
                        `[${memo.date}] (${memo.change > 0 ? '+' : ''}${memo.change}ì ) ${memo.text}`
                    ).join('\n');
                    
                    exportData.push({ 'ë°˜': `${currentClassNum}ë°˜`, 'ë²ˆí˜¸': student.number, 'ì´ë¦„': student.name, 'ì ìˆ˜': score, 'ë©”ëª¨': memoTexts });
                });
            });
            
            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    redirect: 'follow',
                    body: JSON.stringify({ 
                        timestamp: timestamp, 
                        sheetName: sheetName,
                        data: exportData 
                    })
                });
                
                // Google Apps Script redirects, so we can't easily check response.ok.
                // Instead, we assume success if no network error is thrown.
                if (response.type === 'opaque' || response.ok) {
                   await showModal({ title: 'ì„±ê³µ', message: `'${sheetName}' ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì‹œíŠ¸ë¡œ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤!`, showInput: false });
                } else {
                   throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${response.status})`);
                }

            } catch (error) {
                console.error('ì‹œíŠ¸ ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                await showModal({ 
                    title: 'ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜ (Failed to fetch)', 
                    message: `ì‹œíŠ¸ë¡œ ë‚´ë³´ë‚´ëŠ” ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br><br>
                              <b>ê°€ì¥ ë¨¼ì €, Google Apps Script ì‹¤í–‰ ë¡œê·¸ì—ì„œ ì‹¤ì œ ì˜¤ë¥˜ ì›ì¸ì„ í™•ì¸í•´ë³´ì„¸ìš”.</b><br>
                              <ol style="padding-left: 20px; text-align: left; margin-bottom: 15px;">
                                  <li>ì˜¤ë¥˜ ë°œìƒ í›„, Apps Script í¸ì§‘ê¸°ë¡œ ì´ë™í•˜ì„¸ìš”.</li>
                                  <li>ì™¼ìª½ ë©”ë‰´ì—ì„œ <b>'ì‹¤í–‰' (&#9201;)</b> ì•„ì´ì½˜ì„ í´ë¦­í•˜ì„¸ìš”.</li>
                                  <li>ê°€ì¥ ìµœê·¼ì˜ ì‹¤í–‰ ê¸°ë¡ì„ ì°¾ì•„ 'ìƒíƒœ'ê°€ 'ì‹¤íŒ¨'ì¸ì§€ í™•ì¸í•˜ê³ , í•´ë‹¹ í–‰ì„ í´ë¦­í•˜ì—¬ ë¡œê·¸ë¥¼ ì‚´í´ë³´ì„¸ìš”. ë¡œê·¸ì— ë‚˜íƒ€ë‚œ ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ ë¬¸ì œ í•´ê²°ì˜ ê°€ì¥ ì¤‘ìš”í•œ ë‹¨ì„œì…ë‹ˆë‹¤.</li>
                              </ol>
                              <b>ë¡œê·¸ í™•ì¸ í›„ì—ë„ ë¬¸ì œê°€ í•´ê²°ë˜ì§€ ì•Šìœ¼ë©´, ì•„ë˜ ë‹¨ê³„ë¥¼ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”. ê°€ì¥ í”í•œ ì›ì¸ì€ ê¶Œí•œ ë¬¸ì œì…ë‹ˆë‹¤.</b><br>
                              <ol style="padding-left: 20px; text-align: left;">
                                  <li>Apps Script í¸ì§‘ê¸°ì—ì„œ ì˜¤ë¥¸ìª½ ìƒë‹¨ì˜ íŒŒë€ìƒ‰ <b>'ë°°í¬'</b> ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</li>
                                  <li><b>'ë°°í¬ ê´€ë¦¬'</b>ë¥¼ ì„ íƒí•˜ì„¸ìš”.</li>
                                  <li>í™œì„±í™”ëœ ë°°í¬ ì˜†ì˜ <b>ìˆ˜ì •(âœï¸)</b> ì•„ì´ì½˜ì„ í´ë¦­í•˜ì„¸ìš”.</li>
                                  <li>'ë²„ì „' ë“œë¡­ë‹¤ìš´ì—ì„œ <b>'ìƒˆ ë²„ì „'</b>ì„ ì„ íƒí•©ë‹ˆë‹¤. <b>(âš ï¸ ê°€ì¥ ì¤‘ìš”!)</b></li>
                                  <li>'ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì'ê°€ '<b>ëª¨ë“  ì‚¬ìš©ì</b>'ë¡œ ë˜ì–´ ìˆëŠ”ì§€ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.</li>
                                  <li>ë§ˆì§€ë§‰ìœ¼ë¡œ íŒŒë€ìƒ‰ <b>'ë°°í¬'</b> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì™„ë£Œë©ë‹ˆë‹¤.</li>
                              </ol>`, 
                    showInput: false 
                });
            } finally {
                btnElement.disabled = false;
                btnElement.innerHTML = originalBtnHTML;
            }
        }

        function init() {
            loadData();
            createDynamicContent();
            createStudentCards();
            updateDisplay();

            document.getElementById('resetBtn').addEventListener('click', resetData);
            document.getElementById('exportBtn').addEventListener('click', (event) => exportToSheet(null, event.currentTarget));
            document.getElementById('settingsBtn').addEventListener('click', () => showSettingsModal(false));
            
            // Periodically save data to prevent loss
            setInterval(saveData, 15000); 
            window.addEventListener('beforeunload', saveData);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>